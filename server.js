/**
 * [FILE: server.js]
 * 역할: 웹 서버의 메인 실행 파일입니다.
 * 모든 외부 부품(Express, Router, Scheduler)을 조립하고 서버를 가동합니다.
 */

// ---------------------------------------------------------
// 1. 외부 모듈 및 라이브러리 로드
// ---------------------------------------------------------
const express = require('express');           // 웹 서버 제작을 위한 Node.js 프레임워크 로드
const path = require('path');                  // 파일 및 폴더 경로 조작을 위한 내장 도구 로드
const { startScheduler } = require('./utils/scheduler'); // 매주 월요일 초기화 및 백업을 담당하는 스케줄러 로드
const apiRoutes = require('./routes/api');    // 신청, 취소, 현황 등 실제 API 비즈니스 로직이 담긴 라우터 로드

// ---------------------------------------------------------
// 2. 서버 설정 및 기본 변수 선언
// ---------------------------------------------------------
const app = express();                        // Express 애플리케이션 객체 생성 (서버의 본체)
const port = 3000;                            // 서버가 손님을 맞이할 문 번호 (포트 번호) 설정

// ---------------------------------------------------------
// 3. 미들웨어 및 정적 파일 경로 설정
// ---------------------------------------------------------
// 브라우저에서 'public' 폴더 안의 파일들(HTML, CSS, JS)을 바로 꺼내갈 수 있게 공개함
app.use(express.static(path.join(__dirname, 'public')));

// 클라이언트가 보낸 데이터가 JSON 형식일 때, 이를 해석해서 req.body에 넣어줌
app.use(express.json()); 

// 클라이언트가 HTML 폼 데이터(URL-encoded)를 보낼 때, 이를 해석함
app.use(express.urlencoded({ extended: true }));

// ---------------------------------------------------------
// 4. API 경로(라우터) 연결
// ---------------------------------------------------------
// "/api"로 시작하는 모든 요청(예: /api/apply)은 'apiRoutes' 파일에서 처리하도록 위임함
app.use('/api', apiRoutes);

// ---------------------------------------------------------
// 5. 기본 루트 경로 설정
// ---------------------------------------------------------
// 브라우저 주소창에 아무것도 안 쓰고 접속했을 때(/), 'public' 폴더 안의 'index.html'을 전송함
app.get('/', (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'index.html'));
});

// ---------------------------------------------------------
// 6. 부가 서비스 실행 및 서버 시작
// ---------------------------------------------------------
// 서버가 켜짐과 동시에 매주 월요일 초기화를 감시하는 스케줄러를 가동함
startScheduler(); 

// 지정된 포트(3000)에서 서버가 대기 상태로 들어감 (가게 오픈!)
app.listen(port, () => {
    console.log(`🚀 서버가 http://localhost:${port} 에서 돌아가고 있습니다.`);
});